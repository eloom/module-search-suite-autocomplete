define(["jquery","uiComponent","uiRegistry","underscore","jquery/jquery-storageapi"],function(d,k,e,h){d.Suggestion=function(a){this.url=a.url;this.title=a.title;this.num_results=a.num_results};d.Product=function(a){this.name=a.name;this.sku=a.sku;this.image=a.image;this.reviews_rating=a.reviews_rating;this.short_description=a.short_description;this.description=a.description;this.price=a.price;this.url=a.url;this.add_to_cart=a.add_to_cart};return k.extend({defaults:{localStorage:d.initNamespaceStorage("searchsuiteautocomplete").localStorage,
searchText:""},load:function(){var a=this;this.xhr&&this.xhr.abort();this.xhr=d.ajax({method:"get",dataType:"json",url:this.url,data:{q:this.searchText},beforeSend:function(){a.spinnerShow();a.loadFromLocalSorage(a.searchText)&&a.showPopup()},success:d.proxy(function(b){a.parseData(b);a.saveToLocalSorage(b,a.searchText);a.spinnerHide();a.showPopup()})})},showPopup:function(){e.get("searchsuiteautocompleteBindEvents",function(a){a.showPopup()})},spinnerShow:function(){e.get("searchsuiteautocompleteBindEvents",
function(a){a.spinnerShow()})},spinnerHide:function(){e.get("searchsuiteautocompleteBindEvents",function(a){a.spinnerHide()})},parseData:function(a){this.setSuggested(this.getResponseData(a,"suggest"));this.setProducts(this.getResponseData(a,"product"))},getResponseData:function(a,b){var c=[];if(h.isUndefined(a.result))return c;d.each(a.result,function(f,g){g.code==b&&(c=g)});return c},setSuggested:function(a){var b=[];h.isUndefined(a.data)||(b=d.map(a.data,function(c){return new d.Suggestion(c)}));
e.get("searchsuiteautocomplete_form",function(c){c.result.suggest.data(b)})},setProducts:function(a){var b=[];h.isUndefined(a.data)||(b=d.map(a.data,function(c){return new d.Product(c)}));e.get("searchsuiteautocomplete_form",function(c){c.result.product.data(b);c.result.product.size(a.size);c.result.product.url(a.url)})},loadFromLocalSorage:function(a){if(this.localStorage){a=this._hash(a);a=this.localStorage.get(a);if(!a)return!1;this.parseData(a);return!0}},saveToLocalSorage:function(a,b){this.localStorage&&
(b=this._hash(b),this.localStorage.remove(b),this.localStorage.set(b,a))},_hash:function(a){a=JSON.stringify(a)+"";var b=0,c;if(0==a.length)return b;var f=0;for(c=a.length;f<c;f++){var g=a.charCodeAt(f);b=(b<<5)-b+g;b|=0}return"h"+b}})});
